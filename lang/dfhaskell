# -*- mode: dockerfile -*-
# Haskell dockerfile
#
# This dockerfile creates the haskell image. It derives from the base.
#
# Copyright (c) 2021 Arvind Devarajan
# Licensed to you under the MIT License.
# See the LICENSE file in the project root for more information.
#
FROM onspot/devlab:2.0

USER root 

# Install ca certificates from curl's site itself, and also all dependencies
RUN wget http://curl.haxx.se/ca/cacert.pem -O /etc/pki/trust/anchors/cacert.pem && \
    update-ca-certificates && zypper -n install gcc-c++ gcc gmp-devel make ncurses-devel \
    python3-pip git ncurses-devel zeromq-devel cairo-devel pango-devel \
    file-devel blas-devel lapack-devel

# Update path to include ghcup binaries
RUN echo "pupdate ~/.ghcup/bin" >> /etc/zsh.zshrc.local
RUN echo "pupdate ~/.cabal/bin" >> /etc/zsh.zshrc.local
RUN echo "pupdate ~/.local/bin" >> /etc/zsh.zshrc.local

# New paths for haskell installations
ENV PATH=/home/dev/.ghcup/bin:/home/dev/.cabal/bin:${PATH}

USER dev
WORKDIR /home/dev

# Create these variables so that programs running inside the containers know
# what language they can make use of.
ENV DEVLABLANG=${LANG}
ENV DEVLABVER=${VER}

# Install GHCUP non-interactively (for cabal users)
ENV BOOTSTRAP_HASKELL_NONINTERACTIVE=1
ENV BOOTSTRAP_HASKELL_GHC_VERSION=${DEVLABVER}
RUN curl --proto '=https' --tlsv1.2 -sSf https://get-ghcup.haskell.org | sh

# Install haskell stack and its components
RUN sudo zsh -c "curl -sSL https://get.haskellstack.org/ | sh"

# Install IHaskell
RUN git clone https://github.com/gibiansky/IHaskell .ihaskellsrc && \
    cd .ihaskellsrc && pip3 install -r requirements.txt && \
    stack config set system-ghc --global true && \
    stack install --system-ghc --fast && ihaskell install --stack

# THE STATEMENT BELOW FAILS DUE TO SOME INCOMPATIBILITY IN
# VERSIONS. IT IS LEFT AS-IT-IS TO ENABLE LATER WHEN THESE
# PROBLEMS ARE SOLVED.
# Install syntax highlighting got ihaskell
# RUN cd && jupyter labextension install jupyterlab-ihaskell
